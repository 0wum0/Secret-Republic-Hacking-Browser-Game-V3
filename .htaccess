<IfModule mod_rewrite.c>

	RewriteEngine on

	# Make sure directory listing is disabled
	Options +FollowSymLinks -Indexes

	# ======================================================================
	# Security: Block direct access to sensitive directories and files
	# ======================================================================

	# Block access to includes/, vendor/, templates/, tests/, docs/, .git/
	RewriteRule ^includes/ - [F,L]
	RewriteRule ^templates/ - [F,L]
	RewriteRule ^tests/ - [F,L]
	RewriteRule ^docs/ - [F,L]
	RewriteRule ^screens/ - [F,L]
	RewriteRule ^lang/ - [F,L]
	RewriteRule ^MISSION-GUIDES/ - [F,L]
	RewriteRule ^\.git/ - [F,L]

	# Block access to composer files, markdown, shell scripts, logs, tpl
	RewriteRule composer\.(json|lock)$ - [F,L]
	RewriteRule \.md$ - [F,L]
	RewriteRule \.sh$ - [F,L]
	RewriteRule \.log$ - [F,L]
	RewriteRule \.tpl$ - [F,L]
	RewriteRule \.sql$ - [F,L]
	RewriteRule ^\.phplint-cache$ - [F,L]
	RewriteRule ^\.gitignore$ - [F,L]
	RewriteRule ^LICENSE\.md$ - [F,L]
	RewriteRule ^UPGRADE_NOTES\.md$ - [F,L]
	RewriteRule ^test\.sh$ - [F,L]
	RewriteRule ^phpunit\.xml$ - [F,L]

	# ======================================================================
	# URL Rewriting: Route all requests through index.php
	# ======================================================================

	# Restrict your site to only one domain
	# !important USE ONLY ONE OPTION

	# Option 1: To rewrite "www.domain.com -> domain.com" uncomment the following lines.
	#RewriteCond %{HTTPS} !=on
	#RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
	#RewriteRule ^(.*)$ http://%1/$1 [R=301,L]

	# Option 2: To rewrite "domain.com -> www.domain.com" uncomment the following lines.
	#RewriteCond %{HTTPS} !=on
	#RewriteCond %{HTTP_HOST} !^www\..+$ [NC]
	#RewriteCond %{HTTP_HOST} (.+)$ [NC]
	#RewriteRule ^(.*)$ http://www.%1/$1 [R=301,L]

	# Remove index.php from URL
	#RewriteCond %{HTTP:X-Requested-With}	!^XMLHttpRequest$
	#RewriteCond %{THE_REQUEST}				^[^/]*/index\.php [NC]
	#RewriteRule ^index\.php(.*)$			$1 [R=301,NS,L]

    # make HTTP Basic Authentication work on php-fcgi installs
    <IfModule mod_fcgid.c>
        RewriteCond %{HTTP:Authorization} .
        RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    </IfModule>

	# Send request via index.php if not a real file or directory
	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteCond %{REQUEST_FILENAME} !-d

	# deal with php-fcgi first
	<IfModule mod_fcgid.c>
        RewriteRule ^(.*)$ index.php?/$1 [QSA,L]
	</IfModule>

	# no php-fcgi, check for sapi and fpm
	<IfModule !mod_fcgid.c>

		# for PHP5 sapi installations
		<IfModule mod_php5.c>
			RewriteRule ^(.*)$ index.php/$1 [L]
		</IfModule>

		<IfModule !mod_php5.c>

			# for PHP7 sapi installations
			<IfModule mod_php7.c>
				RewriteRule ^(.*)$ index.php/$1 [L]
			</IfModule>

			<IfModule !mod_php7.c>

				# for PHP8 sapi installations
				<IfModule mod_php.c>
					RewriteRule ^(.*)$ index.php/$1 [L]
				</IfModule>

				# for fpm installations
				<IfModule !mod_php.c>
					RewriteRule ^(.*)$ index.php?/$1 [QSA,L]
				</IfModule>

			</IfModule>

		</IfModule>

	</IfModule>

</IfModule>

# ======================================================================
# Additional Security Headers
# ======================================================================

# Prevent PHP files in includes/ from being accessed directly
<FilesMatch "\.(php|phps|phtml)$">
    # Only index.php and api.php should be accessible
</FilesMatch>

# Block direct access to hidden files (e.g. .gitignore, .env)
<FilesMatch "^\.">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# Block access to backup and config files
<FilesMatch "\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>
